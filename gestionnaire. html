<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Commandes Pain Bio</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 p-4">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">
            <i class="fas fa-bread-slice text-amber-600 mr-2"></i>
            Gestion des Commandes Pain Bio
        </h1>

        <a href="/" class="mb-4 inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            ‚Üê Retour au Formulaire
        </a>

        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex">
                    <button id="tab-list" class="tab-button active py-2 px-4 border-b-2 border-blue-500 text-blue-600 font-medium">
                        <i class="fas fa-list mr-2"></i>Liste des Commandes
                    </button>
                    <button id="tab-summary" class="tab-button py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <i class="fas fa-chart-bar mr-2"></i>R√©capitulatif Boulanger
                    </button>
                </nav>
            </div>
        </div>

        <div id="section-list" class="tab-content">
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">
                        <i class="fas fa-list text-blue-600 mr-2"></i>Liste des Commandes
</h2>
                    <button onclick="emptyAllOrders()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors text-sm">
                        <i class="fas fa-trash mr-2"></i>Vider TOUT
                    </button>
                </div>
                
                <div id="ordersList" class="space-y-4">
                    <div class="text-gray-500 italic">Aucune commande enregistr√©e</div>
                </div>
                <div class="mt-6 text-xl font-bold text-right">
                    Total g√©n√©ral: <span id="totalGeneral">0.00‚Ç¨</span>
                </div>
            </div>
        </div>

        <div id="section-summary" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">
                        <i class="fas fa-chart-bar text-blue-600 mr-2"></i>R√©capitulatif pour le Boulanger
                    </h2>
                    <button onclick="exportSummary()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors text-sm">
                        <i class="fas fa-file-export mr-2"></i>Exporter le Bilan
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-blue-600 text-sm font-medium">Chiffre d'affaires total</div>
                        <div class="text-2xl font-bold text-blue-800" id="summaryRevenue">0.00‚Ç¨</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-green-600 text-sm font-medium">Nombre de commandes</div>
                        <div class="text-2xl font-bold text-green-800" id="summaryCount">0</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <div class="text-yellow-600 text-sm font-medium">Poids total de pain</div>
                        <div class="text-2xl font-bold text-yellow-800" id="summaryWeight">0g</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-purple-600 text-sm font-medium">Ticket moyen</div>
                        <div
class="text-2xl font-bold text-purple-800" id="summaryAverage">0.00‚Ç¨</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-3">R√©partition par type de pain</h3>
                        <div id="breadTypesSummary" class="space-y-2">
                            <div class="text-gray-500 italic">Aucune donn√©e</div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Commandes par date</h3>
                        <div id="datesSummary" class="space-y-2">
                            <div class="text-gray-500 italic">Aucune donn√©e</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cl√©s de stockage
        const STORAGE_KEY = 'orders';
        const PENDING_KEY = 'pendingOrderText'; // Cl√© utilis√©e par le formulaire index.html

        // Chargement initial des commandes
        let orders = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

        // --- Fonctions Utilitaire ---

        // Fonction pour sauvegarder la liste compl√®te et rafra√Æchir l'interface
        function saveAndRefresh() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
            updateOrdersList();
            updateSummary();
        }
        
        // Fonction pour enregistrer une nouvelle commande (utilis√©e par l'auto-import)
        function addOrder(orderData) {
            // Ajouter les m√©tadonn√©es de l'enregistrement
            orderData.id = Date.now();
            orderData.status = 'En attente'; 
            orderData.timestamp = new Date().toISOString(); 
            orderData.autoRenew = orderData.autoRenew || 'Non'; // S'assurer que le champ existe
            orders.push(orderData);
            saveAndRefresh();
        }

        // --- Gestion des Onglets ---

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
 // Changer le style des boutons
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');
                });
                
                button.classList.add('active', 'border-blue-500', 'text-blue-600');
                button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
                
                // Cacher toutes les sections
                document.querySelectorAll('.tab-content').forEach(section => {
                    section.classList.add('hidden');
                });
                
                // Afficher la section cible
                const targetId = button.id.replace('tab-', 'section-');
                document.getElementById(targetId).classList.remove('hidden');
                
                // Mettre √† jour les donn√©es si l'onglet est affich√©
                if (targetId === 'section-list') {
                    updateOrdersList();
                } else if (targetId === 'section-summary') {
                    updateSummary();
                }
            });
        });

        // --- Fonctions d'Analyse (Parsing - Gard√©es pour l'auto-import) ---
        
        // Fonction pour analyser un texte de commande (ESSENTIEL pour l'auto-import)
        function parseOrderText(text) {
            try {
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                
                const order = {
                    name: '',
                    phone: '',
                    email: '',
                    date: '',
                    items: [],
                    total: 0,
                    totalWeight: 0,
                    autoRenew: 'Non' 
                };

                let inItemsSection = false;

                for (let line of lines) {
                    const cleanLine = line.replace(/[üçûüë§üìûüìßüìÖüìã‚Ä¢]/g, '').trim();
                    
                    if (cleanLine.toLowerCase().includes('nom:')) {
                        order.name = cleanLine.split(':')[1]?.trim() || '';
                    } 
                    else if (cleanLine.toLowerCase().includes('t√©l√©phone:') || cleanLine.toLowerCase().includes('telephone:')) {
                        order.phone = cleanLine.split(':')[1]?.trim() || '';
                    }
                    else if (cleanLine.toLowerCase().includes('email:')) {
                        order.email = cleanLine.split(':')[1]?.trim() || '';
                    }
                    else if (cleanLine.toLowerCase().includes('date souhait√©e:') || cleanLine.toLowerCase().includes('date souhaitee:')) {
                        order.date = cleanLine.split(':')[1]?.trim() || '';
                    }
                    else if (cleanLine.toLowerCase().includes('renouvellement automatique:')) {
                        order.autoRenew = cleanLine.split(':')[1]?.trim() || 'Non';
                    }
                    else if (cleanLine.toLowerCase().includes('commande:')) {
                        inItemsSection = true;
                        continue;
                    }
                    else if (cleanLine.toLowerCase().includes('total:')) {
                        const totalMatch = cleanLine.match(/(\d+\.?\d*)/); 
                        if (totalMatch) {
                            order.total = parseFloat(totalMatch[1]);
                        }
                        inItemsSection = false;
                    }
                    else
if (inItemsSection && cleanLine.includes(':')) {
                        const item = parseOrderItem(cleanLine);
                        if (item) {
                            order.items.push(item);
                            order.totalWeight += item.weight * item.quantity;
                        }
                    }
                }

                if (order.items.length === 0 || !order.name || !order.date) return null;

                return order;
            } catch (error) {
                console.error('Erreur lors du parsing:', error);
                return null;
            }
        }

        // Fonction pour analyser un article de commande (ESSENTIEL pour l'auto-import)
        function parseOrderItem(line) {
            try {
                // Regex: nom poids: quantit√© x prix = total
                const regex = /^(.+?)(\d+g?):\s*(\d+)\s*x\s*(\d+\.?\d*)[‚Ç¨]?\s*=\s*(\d+\.?\d*)[‚Ç¨]?/i;
                const match = line.match(regex);
                
                if (match) {
                    const [, name, weightStr, quantity, price, total] = match;
                    const weight = parseInt(weightStr.replace('g', '')) || 0;
                    
                    return {
                        name: name.trim(),
                        weight: weight,
                        quantity: parseInt(quantity) || 0,
                        price: parseFloat(price) || 0,
                        total: parseFloat(total) || 0
                    };
                }
                return null;
            } catch (error) {
                console.error('Erreur lors du parsing de l\'item:', error);
                return null;
            }
        }

        // --- Logique Liste des Commandes ---

        window.emptyAllOrders = function() {
            if (confirm("ATTENTION: √ätes-vous s√ªr de vouloir supprimer TOUTES les commandes enregistr√©es ? Cette action est irr√©versible.")) {
                localStorage.removeItem(STORAGE_KEY);
                orders = [];
                saveAndRefresh();
                alert("Toutes les commandes ont √©t√© supprim√©es.");
            }
        }

        function updateOrdersList() {
            const listContainer = document.getElementById('ordersList');
            const totalGeneralElement = document.getElementById('totalGeneral');
            listContainer.innerHTML = '';
            
            let totalGeneral = 0;
            
            if (orders.length === 0) {
                listContainer.innerHTML = '<div class="text-gray-500 italic">Aucune commande enregistr√©e</div>';
                totalGeneralElement.textContent = '0.00‚Ç¨';
                return;
            }
            
            orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            orders.forEach((order, index) => {
                // Re-calculer l'index bas√© sur la position r√©elle apr√®s le tri
                const originalIndex = orders.findIndex(o => o.id === order.id); 

                totalGeneral += order.total;
                const statusColor = order.status === 'Pay√©' ? 'bg-green-100 text-green-800' : 
                                    order.status === 'Envoy√©' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800';
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-4 border border-gray-200 rounded-lg shadow-sm bg-white';
                itemDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold">${order.name} - ${order.total.toFixed(2)}‚Ç¨</h3>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">${order.status}</span>
</div>
                    <p class="text-sm text-gray-600">Date Livraison: ${order.date} | T√©l√©phone: ${order.phone || 'N/A'}</p>
                    <p class="text-sm text-gray-600 mb-2">Renouvellement: ${order.autoRenew}</p>
                    <div class="text-xs ml-2 border-l pl-2 mt-2">
                        ${order.items.map(item => 
                            `‚Ä¢ ${item.name} ${item.weight}g: ${item.quantity} unit√©s`
                        ).join('<br>')}
                    </div>
                    <div class="mt-3 flex gap-2 justify-end">
                        <button onclick="toggleStatus(${originalIndex}, 'Envoy√©')" class="bg-blue-500 text-white px-3 py-1 text-sm rounded hover:bg-blue-600">Envoy√©</button>
                        <button onclick="toggleStatus(${originalIndex}, 'Pay√©')" class="bg-green-500 text-white px-3 py-1 text-sm rounded hover:bg-green-600">Pay√©</button>
                        <button onclick="deleteOrder(${originalIndex})" class="bg-red-500 text-white px-3 py-1 text-sm rounded hover:bg-red-600">Supprimer</button>
                    </div>
                `;
                listContainer.appendChild(itemDiv);
            });
            
            totalGeneralElement.textContent = totalGeneral.toFixed(2) + '‚Ç¨';
        }

        window.deleteOrder = function(index) {
            if (confirm("√ätes-vous s√ªr de vouloir supprimer cette commande ?")) {
                orders.splice(index, 1);
                saveAndRefresh();
            }
        }

        window.toggleStatus = function(index, newStatus) {
            const currentStatus = orders[index].status;
            
            if (currentStatus === newStatus) {
                orders[index].status = 'En attente';
            } else {
                orders[index].status = newStatus;
            }

            saveAndRefresh();
        }

        // --- Logique R√©capitulatif Boulanger ---

        window.exportSummary = function() {
            const date = new Date().toISOString().slice(0, 10);
            let exportContent = `--- BILAN COMMANDES PAIN BIO - ${date} ---\n\n`;

            // R√©capitulatif par produit
            const breadSummaryContainer = document.getElementById('breadTypesSummary');
            exportContent += "R√âCAPITULATIF PAR TYPE DE PAIN:\n";
            exportContent += breadSummaryContainer.innerText.replace(/\n\s*\n/g, '\n').trim() + "\n\n";

            // R√©capitulatif par date
            const datesSummaryContainer = document.getElementById('datesSummary');
            exportContent += "R√âCAPITULATIF PAR DATE DE LIVRAISON:\n";
            exportContent += datesSummaryContainer.innerText.replace(/\n\s*\n/g, '\n').trim() + "\n\n";

            // Totaux
            exportContent += "TOTAUX G√âN√âRAUX:\n";
            exportContent += `Chiffre d'affaires total: ${document.getElementById('summaryRevenue').innerText}\n`;
            exportContent += `Nombre de commandes: ${document.getElementById('summaryCount').innerText}\n`;
            exportContent += `Poids total de pain: ${document.getElementById('summaryWeight').innerText}\n`;
            exportContent += `Ticket moyen: ${document.getElementById('summaryAverage').innerText}\n\n`;

            // D√©tail des commandes
            exportContent += "--- D√âTAIL DE CHAQUE COMMANDE ---\n\n";
            orders.forEach((order, i) => {
                exportContent += `COMMANDE N¬∞${i + 1} (${order.status.toUpperCase()})\n`;
                exportContent += `Client: ${order.name}\n`;
                exportContent += `T√©l√©phone: ${order.phone || 'N/A'}\n`;
                exportContent += `Email: ${order.email || 'N/A'}\n`;
                exportContent += `Date Livraison: ${order.date}\n`;
                exportContent += `Renouvellement: ${order.autoRenew}\n`;
                exportContent += `Total: ${order.total.toFixed(2)}‚Ç¨\n`;
                exportContent += `D√©tails:\n${order.items.map(item => 
                    `  - ${item.name} ${item.weight}g: ${item.quantity} unit√©s`
                ).join('\n')}\n\n`;
            });
            
            const filename = `bilan_commandes_${date}.txt`;
            const blob = new Blob([exportContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert("Le bilan a √©t√© export√© en tant que fichier texte !");
        }

        function updateSummary() {
            let totalRevenue = 0;
            let totalCount = orders.length;
            let totalWeight = 0;
            const breadTypesSummary = {};
            const datesSummary = {};

            orders.forEach(order => {
                totalRevenue += order.total;
                totalWeight += order.totalWeight;
                
                // Par date
                datesSummary[order.date] = (datesSummary[order.date] || 0) + 1;

                // Par type de pain
                order.items.forEach(item => {
                    const key = `${item.name} ${item.weight}g`;
                    breadTypesSummary[key] = (breadTypesSummary[key] || 0) + item.quantity;
                });
            });

            const ticketMoyen = totalCount > 0 ? (totalRevenue / totalCount) : 0;

            document.getElementById('summaryRevenue').textContent = totalRevenue.toFixed(2) + '‚Ç¨';
            document.getElementById('summaryCount').textContent = totalCount;
            document.getElementById('summaryWeight').textContent = totalWeight + 'g';
            document.getElementById('summaryAverage').textContent = ticketMoyen.toFixed(2) + '‚Ç¨';

            // Affichage types de pain
            const breadSummaryContainer = document.getElementById('breadTypesSummary');
            breadSummaryContainer.innerHTML = '';
            Object.keys(breadTypesSummary).sort().forEach(key => {
                breadSummaryContainer.innerHTML += `
                    <div class="flex justify-between border-b pb-1 text-sm">
                        <span>${key}</span>
                        <span class="font-bold">${breadTypesSummary[key]} unit√©s</span>
                    </div>
                `;
            });
            if (Object.keys(breadTypesSummary).length === 0) {
                breadSummaryContainer.innerHTML = '<div class="text-gray-500 italic">Aucune donn√©e</div>';
            }

            // Affichage par date
            const datesSummaryContainer = document.getElementById('datesSummary');
            datesSummaryContainer.innerHTML = '';
            Object.keys(datesSummary).sort().forEach(key => {
                datesSummaryContainer.innerHTML += `
                    <div class="flex justify-between border-b pb-1 text-sm">
                        <span>${key}</span>
                        <span class="font-bold">${datesSummary[key]} commandes</span>
                    </div>
                `;
            });
            if (Object.keys(datesSummary).length === 0) {
                datesSummaryContainer.innerHTML = '<div class="text-gray-500 italic">Aucune donn√©e</div>';
            }
        }

        // --- LOGIQUE CRUCIALE D'AUTO-IMPORT (GARD√âE) ---

        function checkAndAutoImport() {
            const urlParams = new URLSearchParams(window.location.search);
            const autoSave = urlParams.get('autoSave');

            if (autoSave === 'true') {
                const pendingText = localStorage.getItem(PENDING_KEY);

                if (pendingText) {
                    const newOrder = parseOrderText(pendingText);

                    if (newOrder && newOrder.items.length > 0) {
                        
                        addOrder(newOrder); 
                        
                        localStorage.removeItem(PENDING_KEY); 
                        
                        alert(`‚úÖ Commande de ${newOrder.name} enregistr√©e automatiquement !`);
                        
                        // Nettoyer l'URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        return;
  } else {
                        // Si le parsing √©choue, on loggue pour info mais on nettoie la cl√©
                        console.error("Erreur: La commande automatique n'a pas pu √™tre analys√©e.");
                        localStorage.removeItem(PENDING_KEY); 
                        
                        // Nettoyer l'URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }
            }
            
            updateOrdersList();
            updateSummary();
        }


        // --- Initialisation ---
        
        checkAndAutoImport();

        // Le premier onglet (Liste) est actif par d√©faut
    </script>
</body>
</html>
